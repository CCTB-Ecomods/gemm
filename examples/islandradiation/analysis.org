* Analyses scripts for island diversification experiments

** prepare data files

*** filter compatibility sequences
    two methods of sorting sequences according to header information: awk and sed
    sed feels faster

 #+BEGIN_SRC sh 
 ## awk "/compat/{print;getline;print}" 2019-07-02_islsimconfig_7/seqs_s7.fa > 2019-07-02_islsimconfig_7/compats.fa
 for i in ../../2019-12-06_islsim_*/seqs_s[0-9].fa ; do sed -n "/compat/{N;p}" $i > ${i%.fa}_compats.fa done
							
 for i in ../../2019-10-29_islsim_*/seqs_s[0-9][0-9].fa ; do sed -n "/compat/{N;p}" $i > ${i%.fa}_compats.fa done
#+END_SRC

 #+RESULTS:

 make sequences unique

#+BEGIN_SRC sh
 for i in ../../2019-06-28_islsim_*/*compats.fa ; do
     sed -e '/^>/s/$/@/' -e 's/^>/#/' $i |\
	 tr -d '\n' | tr "#" "\n" | tr "@" "\t" |\
	 sort -u -f -k 2  |\
	 sed -e 's/^/>/' -e 's/\t/\n/' |\
	 grep -Ev '^\s*$|^>\s*$' > ${i%compats.fa}uniq.fa
 done
 #+END_SRC

** R analyses
*** Packages

We use an anaconda environment that provides most of the packages.
Using environments alleviates common dependency issues.

Some packages are not supplied by anaconda though and we need to install them in our R environment:

 #+BEGIN_SRC R
   install.packages("dispRity")
   install.packages("paleotree")
   install.packages("lmerTest") # TODO: try including this in conda environment!
 #+END_SRC

 #+RESULTS:

Note that trying to install some of the above packages' dependencies via conda leads to conflicts, while it works directly in R.

Now, we can load the packages.

#+BEGIN_SRC R
 library(picante) ## provides both library(vegan) and library(ape) ade4?
 ## library(corrplot)
 library(cowplot) # arrange ggplots in a grid
 ## library(cluster)
 ## library(fpc) # additional cluster analysis functionalities
 library(factoextra) # additional ordination visualisation
 library(FactoMineR) # additional ordination methods
 library(dispRity) # calculates various measures of disparity of e.g. species w/ multivariate trait data CAVEAT: conflicts with paleotree
## library(matrixStats) # rowSds etc.
## library(geometry) # for convex hulls etc.
 library(paleotree)
 library(foreach)
 library(doParallel)
 library(tidyverse)
 library(lme4)
 library(lmerTest)
 library(sandwich)
 library(multcomp) ## caveat: mvtnorm conflicts with dispRity/geiger
 theme_set(theme_classic()) ## or theme_linedraw?
#+END_SRC
*** set up parallel computing
#+BEGIN_SRC R
max_cores <- detectCores() - 1
registerDoParallel(16)
#+END_SRC

*** Custom functions

#+BEGIN_SRC R
read_indfiles = function(path = "", pattern = "", suffix = "") {
    indfiles = Sys.glob(paste0(path, pattern, suffix))
    rawinds = tibble()
    for (filepath in indfiles) {
      inds = read_tsv(filepath)
      inds$replicate = as.numeric(strsplit(strsplit(filepath, ".tsv")[[1]], "_s")[[1]][2])
      rawinds = bind_rows(rawinds, inds)
    }
    rawinds$lineageid = paste(rawinds$lineage, rawinds$id, sep="_")
    rawinds %>% select(-starts_with("X", ignore.case = FALSE)) # most likely empty columns due to superfluous separators
}

read_seqfiles = function(path = "", pattern = "", suffix = "") { ## path, pattern and suffix might be combined
  seqfiles = Sys.glob(paste0(path, pattern, suffix))
  seqs = foreach (filepath = seqfiles, .combine = rbind) %dopar% {
    ## if (which(seqfiles == filepath) == 1) {
    ##       seqs = read.dna(file = filepath, format="fasta")
    ##   } else {
    newseq = read.dna(file=filepath, format="fasta")
    ##         if (length(newseq[1, ]) >= 100) seqs = rbind(seqs, newseq)
    ## }
  }
  seqs
}

reducetips = function(seqs, ntips = 10000){ #this reduces tips to a maximum of 10000 to prevent the vector allocation error
    if(length(seqs[,1]) > ntips){                                                                                                                                                  
        inds = sample(1:length(seqs[,1]), ntips)                                                                                                                                   
        seqs = seqs[inds,]
    }
    seqs
}

gettree = function(linseqs, maxtips = 10000){
  if (length(linseqs[,1]) > 1) {
    linseqs = reducetips(linseqs, maxtips)
    dists = dist.dna(linseqs, model = "raw") # raw better fitting than either F81 or JC69
    tre = hclust(dists, method = "ward.D2")
    tre$height <- round(tre$height, 6) # work-around 'height' component of 'tree' is not sorted (increasingly) error
    tre
  } else {
    NULL
  }
}

inferspecies = function(tre, spboundary){
  if (!is.null(tre)) {
    grps = cutree(tre, h = spboundary) # which height? constant (e.g. 2 base pairs difference) or species-specific?
    ## medreptol = rawinds %>% filter(lineage==lineage) %>% select(reptol) %>% as_vector %>% median
    ## how to decide what tips to drop when spanning large time scales?
    grps
  } else {
    tre
  }
}  

mksptree = function(tre, grps){
  if (!is.null(tre)) {
    species = drop.tip(as.phylo(tre), names(grps[duplicated(grps)]))
    species
  } else {
    tre
  }
}  

filterseqs = function(linseqs, rawinds, lineage) {
##    linseqs = allseqs[seqlins == lineage,]
    dimnames(linseqs)[[1]] = strsplit(dimnames(linseqs)[[1]], "_") %>% lapply(function(x) paste(x[1], x[2], sep = "_")) %>% unlist ## assumes correct sequences are already filtered
    linseqs = linseqs[!duplicated(dimnames(linseqs)[[1]]),]
    adlts = rawinds %>% filter(lineage == !!lineage, size >= repsize) %>%
      group_by(lineageid) %>% select(time) %>% filter(time == max(time)) %>%
      ungroup %>% select(lineageid) %>% unlist
    linseqs = linseqs[dimnames(linseqs)[[1]] %in% adlts,]
    linseqs
}  

mkphylos = function(allseqs, rawinds, minimumtips = 3, maxtips = 30000, spboundary = 0.05){
##  seqlins = strsplit(dimnames(allseqs)[[1]], "_") %>% lapply(function(x) x[1]) %>% unlist #%>% unique %>% gsub(">", "", .)
  colids = rawinds %>% filter(time == 0) %>% select(lineageid) %>% unlist
  founderlins = rawinds %>% filter(!(lineageid %in% colids)) %>% select(lineage) %>% unique %>% unlist
  allphylos = foreach(lineage = founderlins) %dopar% { ##unique(seqlins[seqlins %in% founderlins])) %dopar% {
    linseqs = filterseqs(allseqs, rawinds, lineage)
    if (length(linseqs[,1]) >= minimumtips) {
      if (spboundary == "actual") {
        spboundary = rawinds %>% filter(time == 0, lineage == !!lineage) %>%
          select(reptol) %>% min ## colonizing mainland individual able to reintegrate into island population
        spboundary = 1 - spboundary
      }
      tre = gettree(linseqs, maxtips)
      grps = inferspecies(tre, spboundary)
      species = mksptree(tre, grps)
      times = rawinds %>% filter(lineage==!!lineage, time != 0) %>% select(time, lineageid) %>%
        inner_join(tibble(lineageid = names(grps), grps = grps), by = "lineageid") %>% 
        group_by(grps) %>% summarize(FAD=min(time), LAD=max(time)) %>%
        inner_join(tibble(lineageid = names(grps), grps = grps), by = "grps") # tip labels are `lineageid`s, not the species id, i.e. `grp`
      times = times %>% filter(lineageid %in% species$tip.label) %>% as.data.frame
      rownames(times) = times$lineageid
      times = times %>% select(-lineageid, -grps)
      extantids = rawinds$lineageid[rawinds$lineage==lineage & rawinds$time==max(times$FAD)] #FIXME! ?
      extantseqs = linseqs[dimnames(linseqs)[[1]] %in% extantids,]
      extanttree = gettree(extantseqs)
      extant = mksptree(extanttree, inferspecies(extanttree, spboundary))
      times = abs(times - 1000000) # fixed subtraction for comparability
      if (nrow(times) > 1 & length(species$tip.label) >= minimumtips) {
        timed = timePaleoPhy(species, times, vartime=499, type="basic") ## default is "basic". "mbl" increases zero-length branches.
      } else {
        timed = times
      }
      list(tree=tre, grps=grps, species=species, timed=timed, extant=extant)
    }
  }
  names(allphylos) = founderlins ##unique(seqlins[seqlins %in% founderlins])
  allphylos[!sapply(allphylos, is.null)]
}

gettimedspp = function(phylos, inds) {
  timeddiv = foreach(i = 1:length(phylos)) %dopar% {
    steplength = inds %>% filter(lineage == names(phylos[1])) %>% select(time) %>% unlist %>% sort %>% unique %>% diff %>% min
    if (names(phylos[[i]]$timed)[1] != "FAD") {
      as_tibble(phyloDiv(phylos[[i]]$timed, int.length = steplength, plot = FALSE))
    } else {
      tibble(int.start = phylos[[i]]$timed$FAD, int.end = phylos[[i]]$timed$LAD, int.div = 1)
    }
  }
  names(timeddiv) = names(phylos)
  timeddiv
}

plot_phylos = function(allphylos, rawinds, basename = "all_timed_trees", minimumtips = 3, spboundary = 0.05){
  pdf(paste0(basename, minimumtips, "mintips", "-", spboundary, "spbnd", ".pdf"))
  for(i in 1:length(allphylos)) {
    if (names(phylos[[i]]$timed)[1] != "FAD") {
      phyloDiv(allphylos[[i]]$timed)
      linkage = rawinds %>% filter(lineage == names(allphylos[i])) %>% select(lnkgunits, ngenes) %>% unique %>%
        mutate(linkage = ngenes/lnkgunits) %>% select(linkage)
      title(main=paste(names(allphylos[i]), linkage[1]))
      if (!is.null(allphylos[[i]]$extant)) plot(allphylos[[i]]$extant)
    }
  }
  dev.off()
}

gettimemaxspp = function(timedspp, inds, filtermonospp = FALSE) {
  timemaxspp = tibble(
    lineage = names(timedspp),
    maxspp = sapply(timedspp, function(x) max(x$int.div)),
    medianspp = sapply(timedspp, function(x) median(x$int.div)),
    timetofirstclad = sapply(timedspp, function(x) ifelse(max(x$int.div) > 1,
                                                       max(x$int.start) - max(x$int.start[x$int.div > 1]), ## Times are reverse: present is 0
                                                       NA)),
    timetomaxspp = sapply(timedspp, function(x) ifelse(max(x$int.div) > 1,
                                                       max(x$int.start) - x$int.start[which.max(x$int.div)], ## Times are reverse: present is 0
                                                       NA)),
    )
  timemaxspp = inds %>% filter(lineage %in% names(timedspp)) %>% group_by(lineage) %>%
    select_if(is.numeric) %>% summarize_all(mean) %>%
    select(lineage, lnkgunits, ngenes) %>% mutate(linkage = ngenes / lnkgunits) %>%
    left_join(timemaxspp, by = "lineage")
  if (filtermonospp == TRUE) {
    timemaxspp %>% filter(maxspp > 1)
  } else {
    timemaxspp
  }
}

getmaxspp = function(inds, timedspp) {
  colids = inds %>% filter(time == 0) %>% select(lineageid) %>% unlist
  founderlins = inds %>% filter(!(lineageid %in% colids)) %>% select(lineage) %>% unique %>% unlist
  maxspp = inds %>% filter(lineage %in% founderlins) %>% group_by(lineage, lnkgunits) %>% ## initial state of species is of highest interest!
    filter(time == max(time) | time == min(time)) %>% mutate(Phase = ifelse(time == max(time), "terminal", "initial")) %>% select(-(time:originid)) %>%
    group_by(lineage, lnkgunits, Phase) %>%  select(-new, -contains("adaptation"), -ngenes, -compat) %>% select_if(is.numeric) %>%
    summarize_all(mean) %>% right_join(gettimemaxspp(timedspp, inds, FALSE), by = c("lineage", "lnkgunits")) %>%
    mutate(`Category/phase` = paste(ifelse(maxspp > 1, "diverged", "monospecific"), Phase), diverged = ifelse(maxspp > 1, 1, 0)) %>%
    ungroup() %>% mutate_at(vars(repsize, seedsize), function(x) log(x + 1))
  maxspp
}

#+END_SRC

*** aggregate data

**** Using custom functions and parallelisation to prepare data structure

#+BEGIN_SRC R
setwd("/gaia5/storage/ecomod/ludwig/hpc/islspecmod/examples/islandradiation/")

full.inds = read_indfiles(path = "../../2019-10-29_islsim_", pattern = "full*/inds*", suffix = ".tsv")
none.inds = read_indfiles("../../2019-10-29_islsim_", "none*/inds*", ".tsv")
full.seqs = read_seqfiles(path = "../../2019-10-29_islsim_", pattern = "full*/", suffix = "*compats.fa")
none.seqs = read_seqfiles("../../2019-10-29_islsim_", "none*/", "*compats.fa")

full.phylos = mkphylos(full.seqs, full.inds, spboundary = "actual")
none.phylos = mkphylos(none.seqs, none.inds, spboundary = "actual")

full.timedspp = gettimedspp(full.phylos, full.inds)
none.timedspp = gettimedspp(none.phylos, none.inds)

rand.inds = read_indfiles("../../2020-02-*_islsimconfig", "*/inds*", ".tsv")
rand.seqs = read_seqfiles("../../2020-02-*_islsimconfig", "*/", "*.fa")

rand.incomplete = rand.inds %>% group_by(replicate) %>% select(time) %>% summarize_all(max) %>% ungroup %>% filter(time <= 850000) %>% select(replicate) %>% unlist
rand.compl = rand.inds %>% group_by(replicate) %>% select(time) %>% ungroup %>% filter(time >= 750000) %>% select(replicate) %>% unlist %>% unique

rand.phylos = mkphylos(rand.seqs, rand.inds %>% filter(replicate %in% rand.compl, time <=750000), spboundary = "actual")
rand.timedspp = gettimedspp(rand.phylos, rand.inds %>% filter(replicate %in% rand.compl, time <=750000))

rand.maxspp = getmaxspp(rand.inds %>% filter(replicate %in% rand.compl, time <=750000), rand.timedspp)

none.compl = none.inds %>% group_by(replicate) %>% select(time) %>% ungroup %>% filter(time >= 700000) %>% select(replicate) %>% unlist %>% unique
full.compl = full.inds %>% group_by(replicate) %>% select(time) %>% ungroup %>% filter(time >= 700000) %>% select(replicate) %>% unlist %>% unique
none.phylos = mkphylos(none.seqs, none.inds %>% filter(replicate %in% none.compl, time <=700000), spboundary = "actual")
none.timedspp = gettimedspp(none.phylos, none.inds %>% filter(replicate %in% none.compl, time <=700000))
none.maxspp = getmaxspp(none.inds %>% filter(replicate %in% none.compl, time <=700000), none.timedspp)
full.phylos = mkphylos(full.seqs, full.inds %>% filter(replicate %in% full.compl, time <=700000), spboundary = "actual")
full.timedspp = gettimedspp(full.phylos, full.inds %>% filter(replicate %in% full.compl, time <=700000))
full.maxspp = getmaxspp(full.inds %>% filter(replicate %in% full.compl, time <=700000), full.timedspp)

rand.phylos05 = mkphylos(rand.seqs, rand.inds %>% filter(replicate %in% rand.compl, time <=750000), spboundary = 0.05)
rand.timedspp05 = gettimedspp(rand.phylos05, rand.inds %>% filter(replicate %in% rand.compl, time <=750000))
rand.maxspp05 = getmaxspp(rand.inds %>% filter(replicate %in% rand.compl, time <=750000), rand.timedspp05)

rand.maxspp = rand.maxspp %>% right_join(tibble(lineage = names(rand.phylos), totalspp = sapply(rand.phylos, function(x) max(x$grps))), by = "lineage")
rand.maxspp$tempdiff = abs(rand.maxspp$tempopt - 298)
#+END_SRC

**** Plot stuff
#+BEGIN_SRC R
rtp = bind_rows(rand.maxspp) %>% filter(Phase == "initial") %>%
  rename(`Mean dispersal distance` = dispmean,
         `Long-distance dispersal` = dispshape,
         `Precipitation optimum` = precopt,
         `Precipitation tolerance` = prectol,
         `Adult biomass (g), log(x+1)` = repsize,
         `Strength of reproductive barrier` = reptol,
         `Propensity to selfing` = selfing,
         `Seed biomass (g), log(x+1)` = seedsize,
         `Temperature optimum` = tempopt,
         `Temperature tolerance` = temptol,
         `Number of genes` = ngenes,
         `Linkage` = linkage
         ) %>% ## gather("Trait", "Trait value", `Mean dispersal distance`:`Linkage`, -replicate) %>% mutate_at(vars(timetomaxspp), log10) %>%
  gather("Trait", "Trait value", `Long-distance dispersal`, `Propensity to selfing`, `Temperature optimum`, `Linkage`) %>% mutate_at(vars(timetomaxspp), log10) %>%
  mutate(diverged = ifelse(diverged == 1, "diverged", "monospecific")) %>%
  ## gather("response", "number", maxspp:timetomaxspp, totalspp) %>%
  ggplot(aes(`Trait value`, maxspp, color = diverged)) + geom_point() + facet_grid(. ~ `Trait`, scales="free") + theme_classic() + scale_color_viridis_d("Lineage divergence") + ylab("Maximum number of species")
ggsave("pairs_rand_maxspp_750k.pdf", rtp, width = 8, height = 2.5)

rtp = bind_rows(rand.maxspp) %>% gather("trait", "value", dispmean:linkage, -replicate) %>% 
  gather("response", "number", medianspp:timetofirstclad) %>%
  ggplot(aes(value, number, color = Phase)) + geom_point() + facet_grid(response ~ trait, scales="free") + theme_bw() + scale_color_viridis_d()
ggsave("pairs_rand_medianspp_750k.pdf", rtp, width = 16, height = 4)
##cor(bind_rows(full.maxspp[, -1], none.maxspp[, -1]))
##cor(rand.maxspp[, -1])

##pdf("corgenspp.pdf", width = 20, height = 20)
##pairs(bind_rows(full.maxspp[, -1], none.maxspp[, -1]))
##pairs(rand.maxspp[, -1])
##dev.off()

##plot number of colonizations/divergences per replicate:
##prefp = rand.maxspp %>% filter(Phase == "terminal") %>% select(replicate, `Category/phase`) %>%
##  ggplot(aes())

rlmsp = rand.maxspp %>% filter(diverged == 1, Phase == "terminal") %>% select(reptol, linkage, maxspp) %>%
  ggplot(aes(reptol, maxspp, color = linkage)) + geom_point() + scale_color_viridis_c()
ggsave("reptol_linkage_maxspp_rand.pdf", rlmsp)

rlmsp = rand.maxspp %>% filter(Phase == "terminal") %>% select(reptol, repsize, maxspp) %>%
  ggplot(aes(reptol, maxspp, color = repsize)) + geom_point() + scale_color_viridis_c()
ggsave("reptol_repsize_maxspp_rand.pdf", rlmsp)

rlmsp = rand.maxspp %>% filter(diverged == 1, Phase == "terminal") %>% select(reptol, dispmean, maxspp) %>%
  ggplot(aes(reptol, maxspp, color = dispmean)) + geom_point() + scale_color_viridis_c()
ggsave("reptol_dispmean_maxspp_rand.pdf", rlmsp)

rlmsp = rand.maxspp %>% filter(Phase == "initial") %>% select(selfing, dispshape, maxspp, ngenes) %>%
  ggplot(aes(selfing, maxspp, color = dispshape, size = ngenes)) + geom_point() + scale_color_viridis_c()
ggsave("selfing_dispshape_initial_maxspp_rand.pdf", rlmsp)

rlmsp = rand.maxspp %>% filter(Phase == "initial") %>% select(selfing, linkage, maxspp, temptol) %>%
  ggplot(aes(selfing, linkage, color = maxspp)) + geom_point() + scale_color_viridis_c()
ggsave("selfing_linkage_initial_maxspp_rand.pdf", rlmsp)

rlmsp = rand.maxspp %>% filter(Phase == "initial") %>% select(selfing, linkage, maxspp, temptol) %>%
  ggplot(aes(selfing, temptol, color = maxspp)) + geom_point() + scale_color_viridis_c()
ggsave("selfing_temptol_initial_maxspp_rand.pdf", rlmsp)

rlmsp = rand.maxspp %>% filter(Phase == "initial") %>% select(selfing, linkage, maxspp, temptol) %>%
  ggplot(aes(selfing, linkage, color = temptol, size = maxspp)) + geom_point() + scale_color_viridis_c()
ggsave("selfing_linkage_temptol_initial_maxspp_rand.pdf", rlmsp)


plot_phylos(full.phylos, full.inds, "full_timed_trees")
plot_phylos(none.phylos, none.inds, "none_timed_trees")
plot_phylos(rand.phylos, rand.inds, "rand_timed_trees")

#+END_SRC
**** Traits over time

#+BEGIN_SRC R
ttp = rand.inds %>% filter(!(lineageid %in% colids)) %>% filter(!(replicate %in% rand.incomplete)) %>% 
  mutate(linkage = ngenes/lnkgunits) %>%
  select(time, lineage, linkage, lnkgunits, ngenes, reptol, selfing, seedsize,
         repsize, dispmean, dispshape, prectol, temptol) %>%
  mutate_at(vars(repsize, seedsize), function(x) log(x + 1)) %>%
  group_by(time, lineage) %>% summarize_all(mean) %>%
  gather(linkage:temptol, key = Trait, value = `Trait value`) %>%
  ggplot(aes(time, `Trait value`, color = lineage)) +
  geom_line() + facet_wrap(. ~ Trait, scales="free")
ggsave("traits_time_all_compl.pdf", ttp, height = 6, width = 12)

ttp = rand.inds %>% filter(lineage %in% rand.maxspp$lineage[rand.maxspp$diverged == 1]) %>%
  mutate(linkage = ngenes/lnkgunits) %>%
  select(time, lineage, linkage, lnkgunits, ngenes, reptol, selfing, seedsize,
         repsize, dispmean, dispshape, prectol, temptol, precopt, tempopt) %>%
  mutate_at(vars(repsize, seedsize), function(x) log(x + 1)) %>%
  group_by(time, lineage) %>% 
  gather(linkage:tempopt, key = Trait, value = `Trait value`) %>%
  ggplot(aes(time, `Trait value`, color = lineage)) +
  stat_summary(aes(color=lineage), fun.y = mean, geom="line", size=1) +
  stat_summary(fun.data=mean_cl_boot, geom="ribbon", alpha=0.1) +
  facet_wrap(. ~ Trait, scales="free")
ggsave("traits_time_lineages.pdf", ttp, height = 6, width = 12)

rand.inds %>% filter(lineage %in% rand.maxspp$lineage[rand.maxspp$diverged == 1]) %>%
  select(lineage, replicate) %>% unique


#+END_SRC

**** Traits distribution

#+BEGIN_SRC R
tdp = rand.maxspp %>% # filter(!(replicate %in% rand.incomplete)) %>% #mutate_at(vars(dispmean:linkage, -replicate), function(x) scale(x, center = FALSE)) %>%
  mutate(diverged = ifelse(diverged == 1, "diverged", "monospecific")) %>%
  rename(`Mean dispersal distance` = dispmean,
         `Long-distance dispersal` = dispshape,
         `Precipitation optimum` = precopt,
         `Precipitation tolerance` = prectol,
         `Adult biomass (g), log(x+1)` = repsize,
         `Strength of reproductive barrier` = reptol,
         `Propensity to selfing` = selfing,
         `Seed biomass (g), log(x+1)` = seedsize,
         `Temperature optimum` = tempopt,
         `Temperature tolerance` = temptol
         ) %>% group_by(Phase, lineage) %>%
  gather(`Mean dispersal distance`:`Temperature tolerance`, key = Trait, value = `Trait value`) %>%
  ggplot(aes(`Phase`, `Trait value`, fill = `diverged`)) +
  geom_violin() + geom_boxplot(width = 0.3, position = position_dodge(0.9)) +
  facet_wrap(. ~ Trait, scales="free") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_viridis_d("Lineage divergence") +
  theme(legend.position=c(.55, .08), legend.justification=c(0, 0))
ggsave("traits_distribution_rand_750k.pdf", tdp, height = 6, width = 9)

tdp = bind_rows(none.maxspp, full.maxspp) %>% #mutate_at(vars(dispmean:linkage, -replicate), function(x) scale(x, center = FALSE)) %>%
  group_by(`Category/phase`, lineage) %>%
  gather(dispmean:temptol, ngenes:linkage, key = Trait, value = `Trait value`) %>%
  ggplot(aes(`Category/phase`, `Trait value`, fill = `Category/phase`)) +
  geom_violin() + geom_boxplot(width = 0.3) + facet_wrap(. ~ Trait, scales="free") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_viridis_d()
ggsave("traits_distribution_full_none.pdf", tdp, height = 8, width = 12)
#+END_SRC

**** PCA

#+BEGIN_SRC R
endpca = prcomp(rand.maxspp %>% rename(`Mean dispersal distance` = dispmean,
         `Long-distance dispersal` = dispshape,
         `Precipitation optimum` = precopt,
         `Precipitation tolerance` = prectol,
         `Adult biomass (g), log(x+1)` = repsize,
         `Strength of reproductive barrier` = reptol,
         `Propensity to selfing` = selfing,
         `Seed biomass (g), log(x+1)` = seedsize,
         `Temperature optimum` = tempopt,
         `Temperature tolerance` = temptol,
         `Number of genes` = ngenes,
         `Linkage` = linkage
         ) %>% filter(Phase == "initial") %>% select(-c(1:4,15,18:25)), scale=T)
endpcaviz = fviz_pca_biplot(endpca, geom.ind="point", fill.ind=rand.maxspp %>% filter(Phase == "initial") %>% mutate(diverged = ifelse(diverged == 1, "diverged", "monospecific")) %>% select(diverged) %>% unlist,
                            pointsize=1, pointshape=21, addEllipses = TRUE, repel = TRUE, title = "", labelsize = 3) + #, ellipse.alpha=0.1, ellipse.type = "convex") +
  theme_bw() + scale_fill_viridis_d("Divergence") + scale_colour_viridis_d("Divergence") +
  xlab("Principal component 1 (21.2%)") + ylab("Principal component 2 (19.1%)") 
ggsave("pca_maintraits_750k.pdf", endpcaviz, width=6, height=4.5)

indpca = prcomp(rand.inds %>% filter(lineage %in% rand.maxspp$lineage, time > 0) %>%
                group_by(lineage) %>% filter(time == min(time)) %>%
                mutate(linkage = ngenes / lnkgunits) %>% ungroup %>%
                select(ngenes:temptol, linkage), scale=T)
endpcaviz = fviz_pca_biplot(indpca, geom.ind="point", fill.ind = rand.inds %>%
                                                        filter(lineage %in% rand.maxspp$lineage, time > 0) %>%
                                                        group_by(lineage) %>% filter(time == min(time)) %>%
                                                        inner_join(rand.maxspp %>% filter(Phase == "initial") %>%
                                                                   select(lineage, diverged), by = "lineage") %>%
                                                        ungroup %>% select(diverged) %>% unlist %>% as.factor(),
                            pointsize=1, pointshape=21, addEllipses = TRUE) + #, ellipse.alpha=0.1, ellipse.type = "convex") +
    theme_bw() + scale_fill_viridis_d("Divergence") + scale_colour_viridis_d("Divergence")
ggsave("pca_maintraits_individuals.pdf", endpcaviz, width=6, height=4)

pdf("pca_maintraits_eigen.pdf")
corrplot(endpca$rotation)
dev.off()
## nice clustering with PCA was with final trait syndrome!

endpca = prcomp(none.maxspp[,-c(1:4,15,17:21)] %>% filter_all(all_vars(!is.na(.))), scale=T)
endpcaviz = fviz_pca_biplot(endpca, geom.ind="point", fill.ind=none.maxspp[,-c(1:4,15,17:19,21)] %>% filter_all(all_vars(!is.na(.))) %>% select(`Category/phase`) %>% unlist,
                            pointsize=1, pointshape=21, addEllipses = TRUE) + #, ellipse.alpha=0.1, ellipse.type = "convex") +
    theme_bw() + scale_fill_viridis_d("Divergence") + scale_colour_viridis_d("Divergence")
ggsave("pca_maintraits_none.pdf", endpcaviz, width=6, height=4)
pdf("pca_maintraits_eigen.pdf")
corrplot(endpca$rotation)
dev.off()

#+END_SRC

**** Lineage-rank plots

#+BEGIN_SRC R
lrp = rand.maxspp %>% filter(Phase == "initial") %>% ggplot(aes(reorder(lineage, -maxspp), maxspp)) +
  geom_bar(stat = "identity") + xlab("Lineage") + ylab("Maximum number of species") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave("lineage_rank_compl.pdf", lrp, width = 5, height = 4)
#+END_SRC

**** Clustering

#+BEGIN_SRC R
rand.kmeans = rand.maxspp %>% filter(Phase == "initial") %>% select(dispmean:linkage, -replicate) %>% kmeans(centers = 2, nstart = 25)
clp = fviz_cluster(rand.kmeans, data = rand.maxspp %>% filter(Phase == "initial") %>% select(dispmean:linkage, diverged, -replicate))
ggsave("kmeans.pdf", clp)
#+END_SRC

**** models
#+BEGIN_SRC R
## lmem not usable because each lineage exclusive to the scenarios
## full model:

fullgenmod = glm(diverged ~ dispshape + repsize + linkage 
                   , data = rand.maxspp %>%
                       filter(Phase == "initial"), binomial)
summary(fullgenmod)

fullmod = lm(maxspp ~ dispshape + reptol + repsize + linkage + tempopt +
                selfing + temptol, data = rand.maxspp %>%
                                                         filter(Phase == "initial"))#, diverged == 1))
summary(fullmod)

fullmod = lm(totalspp ~ dispmean + dispshape + reptol + precopt 
           , data = rand.maxspp %>%
               filter(Phase == "initial"))
summary(fullmod)

fullgenmod = glm(diverged ~ dispshape + linkage + tempopt +
                   selfing, data = rand.maxspp %>%
                              filter(Phase == "initial"), binomial)
summary(fullgenmod)

redgenmod = glm(diverged ~ dispshape + linkage +
                  temptol, data = rand.maxspp %>%
                             filter(Phase == "initial"))
summary(redgenmod)
dtldp = rand.maxspp %>% filter(Phase == "initial") %>% rename(Linkage = linkage) %>%
  mutate(diverged = ifelse(diverged == 1, "diverged", "monospecific")) %>%
  ggplot(aes(dispshape, temptol, size = Linkage, color = diverged)) + geom_point() +
  scale_color_viridis_d("Lineage divergence") + theme_classic() + xlab("Long distance dispersal") +
  ylab("Temperature tolerance") + theme(legend.position=c(1, 1), legend.justification=c(1,1)) +
  theme(legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))
ggsave("dispshape_temptol_linkage_diverged.pdf", dtldp, width = 5, height = 5)

fullmod = lm(maxspp ~ dispmean + dispshape + reptol + repsize + prectol + linkage +
               selfing + ngenes + temptol + tempopt + precopt + seedsize, data = rand.maxspp %>%
                                                                            filter(Phase == "initial", diverged == 1))
redmod = lm(maxspp ~ dispshape + reptol + repsize + prectol + linkage +
               selfing + ngenes + temptol + seedsize, data = rand.maxspp %>%
              filter(Phase == "initial", diverged == 1))
summary(redmod)
dmp = rand.maxspp %>% filter(Phase == "initial") %>% rename(Linkage = linkage) %>%
  mutate(diverged = ifelse(diverged == 1, "diverged", "monospecific")) %>%
  ggplot(aes(dispshape, maxspp)) + geom_point() +
  theme_classic() + xlab("Long distance dispersal") +
  ylab("Maximum species richness per lineage")
ggsave("dispshape_maxspp.pdf", dmp, width = 5, height = 5)


fullmodtimeclad = lm(timetofirstclad ~ dispmean + dispshape + reptol + repsize + prectol + linkage +
                       selfing + ngenes + temptol + tempopt + precopt + seedsize, data = rand.maxspp %>%
                                                                               filter(Phase == "initial", diverged == 1))
redmodtimeclad = lm(timetofirstclad ~ dispshape + reptol +
                      ngenes + temptol, data = rand.maxspp %>%
                                          filter(Phase == "initial", diverged == 1))
summary(redmodtimeclad)

fullmodtimemax = lm(timetomaxspp ~ dispmean + dispshape + reptol + repsize + prectol + linkage +
                  selfing + ngenes + temptol + tempopt + precopt + seedsize, data = rand.maxspp %>%
                                                                               filter(Phase == "initial", diverged == 1))
redmodtimemax = lm(timetomaxspp ~ dispshape +
                     temptol, data = rand.maxspp %>%
                                                                               filter(Phase == "initial", diverged == 1))
summary(redmodtimemax)

fullmixmodtime = lmer(timetofirstclad ~ dispmean + dispshape + reptol + repsize + prectol + linkage +
                        selfing + ngenes + temptol + seedsize + (1|replicate), data = rand.maxspp %>%
                                                                                 filter(Phase == "initial", diverged >= 1))

redmixmod = lmer(maxspp ~ dispshape + linkage +
                selfing + ngenes + temptol + (1|replicate), data = rand.maxspp %>%
                                                                                             filter(Phase == "initial"))
anova(redmixmod)
anova(fullmixmod, redmixmod)

summary(fullgenmixmod)
anova(fullgenmixmod)
summary(fullmixmod)
anova(fullmixmod)

anova(glmer()## %>%
      ##mutate_at(vars(dispmean:linkage, -replicate), scale)))
summary(glmer(diverged ~ dispmean + dispshape + reptol + repsize + prectol + linkage +
                selfing + ngenes + temptol + tempopt + precopt + seedsize + (1|replicate), family = binomial, data = rand.maxspp %>%
                                                                       filter(Phase == "initial")))

summary(glm(diverged ~ dispmean + dispshape + reptol + repsize + prectol + linkage +
                selfing + ngenes + temptol + seedsize,
              family = binomial, data = rand.maxspp %>%
                                   filter(Phase == "initial", !(replicate %in% rand.incomplete))))

anova(glm(diverged ~ dispmean + dispshape + reptol + repsize + prectol + linkage +
                selfing + ngenes + temptol + seedsize,
              family = binomial, data = rand.maxspp %>%
                                   filter(Phase == "initial", !(replicate %in% rand.incomplete))))

##reduced model (backwards elimination: selfing, reptol, repsize, precopt, tempopt, dispmean, seedsize, prectol, ngenes, temptol):

summary(glmer(diverged ~ dispshape + linkage +
                (1|replicate), family = binomial, data = rand.maxspp %>%
                                                                       filter(Phase == "initial", !(replicate %in% rand.incomplete))))## %>%

anova(glmer(diverged ~ dispshape + reptol + prectol + linkage +
                selfing + ngenes + (1|replicate), family = binomial, data = rand.maxspp %>%
                                                                       filter(Phase == "initial") %>%
                                                                       mutate_at(vars(dispmean:linkage, -replicate), scale)))

summary(glmer(diverged ~ dispshape + reptol + prectol + linkage +
                (1|replicate), family = binomial, data = rand.maxspp %>%
                                                                       filter(Phase == "initial", !(replicate %in% rand.incomplete))))## %>%
                                                                       mutate_at(vars(dispmean:linkage, -replicate), scale)))
anova(glmer(diverged ~ dispshape + reptol + prectol + linkage +
                selfing + ngenes + (1|replicate), family = binomial, data = rand.maxspp %>%
                                                                       filter(Phase == "initial") %>%
                                                                       mutate_at(vars(dispmean:linkage, -replicate), scale)))
anova(glmer(diverged ~ dispshape + repsize + reptol + prectol + temptol +
              selfing + seedsize + ngenes + (1|replicate), family = binomial, data = bind_rows(rand.maxspp#, none.maxspp, full.maxspp
                                                                                               ) %>% filter(Phase == "initial")))# %>%
                                                                                mutate(lineage = as.factor(lineage)) %>%
                                                                                mutate_at(vars(dispmean:linkage, -replicate), scale)))
anova(lm(maxspp ~ dispmean + dispshape + repsize + reptol + linkage + prectol + temptol +
             selfing + seedsize + ngenes, data = bind_rows(rand.maxspp#, none.maxspp, full.maxspp
                                                                                           ) %>% ungroup %>% mutate(lineage = as.factor(lineage))))
anova(lm(maxspp ~ temptol * prectol + reptol +
             selfing + ngenes + linkage, data = bind_rows(rand.maxspp#, none.maxspp, full.maxspp
                                                                                           ) %>% ungroup %>% mutate(lineage = as.factor(lineage))))
anova(lm(timetomaxspp ~ dispmean + dispshape + precopt + prectol + repsize + reptol + linkage +
             selfing + seedsize + tempopt + temptol + ngenes, data = bind_rows(rand.maxspp#, none.maxspp, full.maxspp
                                                                                           )))
aov(lm(timetomaxspp ~ dispshape + prectol + repsize + linkage +
             selfing + seedsize + tempopt + temptol + ngenes, data = bind_rows(rand.maxspp#, none.maxspp, full.maxspp
                                                                                           )))
summary(lm(maxspp ~ timetomaxspp + linkage + ngenes, data = bind_rows(rand.maxspp, none.maxspp, full.maxspp)))
summary(lm(timetomaxspp ~ maxspp + linkage + ngenes, data = bind_rows(rand.maxspp, none.maxspp, full.maxspp)))

#+END_SRC
**** Herberich
#+BEGIN_SRC R
mod = aov(diverged ~ dispmean + dispshape + reptol + repsize + prectol + linkage + precopt + tempopt +
                selfing + ngenes + temptol + seedsize, data = rand.maxspp %>%
                                                         filter(Phase == "initial"))

mod = aov(dispshape ~ diverged,
          data = rand.maxspp %>%
            filter(Phase == "initial") %>% mutate(diverged = as.factor(diverged)))
mod.glht = glht(mod, mcp(diverged = "Tukey"), vcov = vcovHC)
summary(mod.glht)

mod = aov(linkage ~ diverged,
          data = rand.maxspp %>%
            filter(Phase == "initial") %>% mutate(diverged = as.factor(diverged)))
mod.glht = glht(mod, mcp(diverged = "Tukey"), vcov = vcovHC)
summary(mod.glht)

mod = aov(selfing ~ diverged,
          data = rand.maxspp %>%
            filter(Phase == "initial") %>% mutate(diverged = as.factor(diverged)))
mod.glht = glht(mod, mcp(diverged = "Tukey"), vcov = vcovHC)
summary(mod.glht)

mod = aov(tempopt ~ diverged,
          data = rand.maxspp %>%
            filter(Phase == "initial") %>% mutate(diverged = as.factor(diverged)))
mod.glht = glht(mod, mcp(diverged = "Tukey"), vcov = vcovHC)
summary(mod.glht)
#+END_SRC

#+BEGIN_SRC R

mod = aov(ngenes ~ group,
          data = rand.maxspp %>%
            mutate(group = as.factor(`Category/phase`)))
mod.glht = glht(mod, mcp(group = "Tukey"), vcov = vcovHC)
summary(mod.glht)


#+END_SRC
**** [#B] GAMs
doesn't work:  Model has more coefficients than data
#+BEGIN_SRC R
rand.gam = mgcv::gam(diverged ~ s(dispshape, bs = "ps", sp=0.6) +
                       s(linkage, bs = "ps", sp=0.6) + s(selfing, bs = "ps", sp=0.6) + s(ngenes, bs = "ps", sp=0.6),
                     data = rand.maxspp %>%
                       filter(Phase == "initial"),
                     method="REML")
#+END_SRC
**** check normality

#+BEGIN_SRC R

## some traits increase in normality with log(x+1) transformation
## TODO: do qqplots for skewness etc. and identify which traits need transformation!

pdf("qqplots.pdf")
bind_rows(rand.maxspp, none.maxspp, full.maxspp) %>% ungroup %>% select(dispmean, dispshape, precopt, prectol,
                                   repsize, reptol, linkage, selfing, seedsize, tempopt, temptol,
                                   ngenes) %>% #mutate_all(function(x) log(x+1)) %>%
  as.list %>% lapply(qqnorm)
dev.off()

rand.maxspp %>% ungroup %>% select(maxspp, timetomaxspp, dispmean, dispshape, precopt, prectol,
                                   repsize, reptol, linkage, selfing, seedsize, tempopt, temptol,
                                   ngenes) %>% mutate_all(function(x) log(x+1)) %>% as.list %>%
                              lapply(shapiro.test)

#+END_SRC
*** Individual-level data

#+BEGIN_SRC R
atp = rand.inds %>% filter(lineage %in% rand.maxspp$lineage, time <= 750000) %>%
  group_by(lineage, time) %>% summarize(Abundance = length(patch_no)) %>% ungroup %>%
  group_by(lineage) %>% select(Abundance) %>% summary
  ggplot(aes(time, Abundance)) + geom_line()
ggsave("Abundances_over_time.pdf", atp)

#+END_SRC
